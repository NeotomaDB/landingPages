---
title: "DOI Redux"
author: "Simon Goring"
date: "January 31, 2018"
  html_document:
    code_folding: null
    keep_md: false
    mathjax: null
    self_contained: true
    number_sections: no
    highlight: null
    toc: no
    theme: yeti
    md_extensions: -autolink_bare_uris
---

```{r setup, include=FALSE}
source('validate_dois.R')
```

## Check DOIs

This code first checks which datasets have been generated by Neotoma to date.

```{r}

output <- validate_dois()

output$neotoma_dataset <- stringr::str_match(output$relatedIdentifier, "downloads/(\\d*),")[,2]

readr::write_csv(output, path='./neotomadois.csv')

```

This indicates that there are now `r nrow(output)` minted DOIs associated but only `r length(unique(output$neotoma_dataset))` datasets minted.  This is part of a problem with the initial implementation and the permissions on the Neotoma Windows Server.

```{r, echo = TRUE, warning = FALSE, message=FALSE, results='hide'}

counter <- list(good = NA,
                bad = list())

all_ds <- neotoma::get_dataset() %>% 
  lapply(function(x)x$dataset.meta$dataset.id)

end_point <- '.'

for (i in 1:length(all_ds)) {
  
  ds_id <- i
  
  dir.create(paste0(end_point, '/', ds_id))
  tester <- try(rmarkdown::render('static_page.Rmd', 
                output_file = paste0(end_point, '/', ds_id, '/index.html'),
                envir = globalenv(), quiet = TRUE))
  
  if (!"try-error" %in% class(tester)) {
    
    counter$good <- na.omit(c(counter$good, ds_id))
    
    # Remove the files for the js. . . 
    unlink(paste0(end_point, '/', ds_id, '/index_files'), 
           force = TRUE, recursive = TRUE)
     
      # Note, this needs to be run as an admin.
      aa <- system(paste0("ln -sr ", end_point , "/index_files/ ", 
                          end_point, "/", ds_id, "/index_files"), intern = TRUE)
  } else {
    new <- length(counter$bad) + 1
    counter$bad[[new]] <- list(ds_id, tester)
  }
      
}
```

This results in a total of `r length(counter$good)` folders and datasets with valid endpoints in the Neotoma data landing page set, and `r length(counter$bad)` dataset IDs without proper landing pages.
